name: Django CI with Scheduled Email Report

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  schedule:
    - cron: "1 * * * *"   # كل يوم 6 صباحًا بتوقيت مصر (UTC+2)

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v3                                  
      with:
        python-version: "3.8"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage flake8

    - name: Run flake8
      run: |
        flake8 . --max-line-length=88 --ignore=E203,W503 > flake8_report.txt || true

    - name: Run tests with coverage
      run: |
        coverage run manage.py test > pytest_report.txt 2>&1 || true
        coverage report -m > coverage_report.txt

    - name: Upload reports
      uses: actions/upload-artifact@v3
      with:
        name: reports
        path: |
          flake8_report.txt
          pytest_report.txt
          coverage_report.txt

  email:
    needs: build
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest

    steps:
    - name: Download reports
      uses: actions/download-artifact@v3
      with:
        name: reports
        path: ./reports

    - name: Prepare email body
      run: |
        echo "=== Django Scheduled CI Report ===" > body.txt
        echo "" >> body.txt

        echo "---- Flake8 ----" >> body.txt
        cat reports/flake8_report.txt >> body.txt
        echo "" >> body.txt

        echo "---- Pytest ----" >> body.txt
        cat reports/pytest_report.txt >> body.txt
        echo "" >> body.txt

        echo "---- Coverage ----" >> body.txt
        cat reports/coverage_report.txt >> body.txt

    - name: Send email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: your_email@example.com
        password: password
        subject: "Django Scheduled CI Report"
        to: your_email@example.com
        from: your_email@example.com
        body: file://body.txt
        secure: true






































# name: Django CI

# on:
#   push:
#     branches: [ "master" ]
#   pull_request:
#     branches: [ "master" ]

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#     - uses: actions/checkout@v4

#     - name: Set up Python
#       uses: actions/setup-python@v3
#       with:
#         python-version: '3.8'

#     - name: Install Dependencies
#       run: |
#         python -m pip install --upgrade pip
#         pip install -r requirements.txt
#         pip install coverage

#     - name: Run flake8
#       run: |
#         echo "hello"

#     - name: Run tests with coverage
#       run: |
#         coverage run manage.py test
#         coverage report -m
    





# name: Django CI

# on:
#   push:
#     branches: [ "master" ]
#   pull_request:
#     branches: [ "master" ]
#   schedule:
#     - cron: "1 * * * *"  # كل يوم الساعة 2 صباحًا UTC
#   workflow_dispatch:

# jobs:
#   build:

#     runs-on: ubuntu-latest
#     strategy:
#       max-parallel: 4
      

#     steps:
#     - uses: actions/checkout@v4
#     - name: Set up Python ${{ matrix.python-version }}
#       uses: actions/setup-python@v3
#       with:
#             python-version: '3.10'
#     - name: Install Dependencies
#       run: |
#         python -m pip install --upgrade pip
#         pip install -r requirements.txt
#     - name: Run Tests
#       run: |
#         python manage.py test
#     - name: Run flake8
#       run: |
#         flake8 . --max-line-length=88 --ignore=E203,W503
#     - name: Run tests with coverage
#       run: |
#         coverage run -m pytest
#         coverage report -m